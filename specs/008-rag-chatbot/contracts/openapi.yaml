openapi: 3.1.0
info:
  title: RAG Chatbot API
  version: 1.0.0
  description: |
    API for the RAG (Retrieval-Augmented Generation) chatbot feature.
    Enables authenticated users to ask questions about book content with
    expertise-level tailored responses.
  contact:
    name: API Support
    email: support@example.com

servers:
  - url: http://localhost:8000
    description: Local development server
  - url: https://api.yourdomain.com
    description: Production server

tags:
  - name: chat
    description: Chat and conversation endpoints
  - name: user
    description: User preferences and settings
  - name: health
    description: Health check and system status

paths:
  /api/chat:
    post:
      tags:
        - chat
      summary: Send a chat message
      description: |
        Submit a question to the chatbot. Requires authentication.
        Returns AI-generated answer grounded in book content with citations.
      operationId: sendChatMessage
      security:
        - BetterAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ChatRequest'
            examples:
              general_question:
                summary: General book question
                value:
                  query: "What is a Vision-Language-Action model?"
                  selected_text: null
                  session_id: "sess_abc123xyz"
              selected_text_question:
                summary: Question about selected text
                value:
                  query: "Can you explain this in simpler terms?"
                  selected_text: "Digital twins are virtual replicas of physical systems that use real-time data and simulation to mirror the behavior, performance, and characteristics of their physical counterparts."
                  session_id: "sess_abc123xyz"
      responses:
        '200':
          description: Successful response
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ChatResponse'
              examples:
                success:
                  value:
                    answer: "A Vision-Language-Action (VLA) model is a type of multimodal AI system that combines visual perception (vision), natural language understanding (language), and robotic control (action) to enable robots to understand and execute tasks based on visual and linguistic inputs."
                    citations:
                      - chapter: "Chapter 4"
                        section: "4.1 Introduction to VLA"
                        line_range: "12-25"
                        file_path: "docs/vla/introduction.mdx"
                      - chapter: "Chapter 4"
                        section: "4.2 VLA Architecture"
                        line_range: "45-67"
                        file_path: "docs/vla/architecture.mdx"
                    agent_used: "Book Q&A Agent"
                    confidence: 0.92
                    chunks_retrieved: 5
        '400':
          description: Bad request (invalid input)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                validation_error:
                  value:
                    error:
                      error_code: "VALIDATION_ERROR"
                      message: "Query must be between 1 and 2000 characters"
                      service: null
                      retry_after: null
        '401':
          description: Unauthorized (authentication required)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                unauthorized:
                  value:
                    error:
                      error_code: "UNAUTHORIZED"
                      message: "Authentication required. Please log in."
                      service: null
                      retry_after: null
        '429':
          description: Rate limit exceeded
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                rate_limit:
                  value:
                    error:
                      error_code: "RATE_LIMIT_EXCEEDED"
                      message: "Too many requests. Please wait before retrying."
                      service: "openai"
                      retry_after: 60
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                service_error:
                  value:
                    error:
                      error_code: "SERVICE_ERROR"
                      message: "AI service temporarily unavailable. Please try again."
                      service: "openai"
                      retry_after: 30

  /api/user/expertise:
    put:
      tags:
        - user
      summary: Update user expertise level
      description: |
        Update the authenticated user's expertise level (beginner, intermediate, advanced).
        This affects how chatbot responses are tailored.
      operationId: updateExpertiseLevel
      security:
        - BetterAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ExpertiseUpdateRequest'
            examples:
              set_advanced:
                summary: Set to advanced level
                value:
                  session_id: "sess_abc123xyz"
                  expertise_level: "advanced"
      responses:
        '200':
          description: Expertise level updated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ExpertiseUpdateResponse'
              examples:
                success:
                  value:
                    success: true
                    new_level: "advanced"
        '400':
          description: Invalid expertise level
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/health:
    get:
      tags:
        - health
      summary: Health check
      description: Check if the API and dependent services are operational
      operationId: healthCheck
      responses:
        '200':
          description: All services healthy
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HealthResponse'
              examples:
                healthy:
                  value:
                    status: "healthy"
                    services:
                      database: "healthy"
                      vector_db: "healthy"
                      ai_service: "healthy"
                    timestamp: "2025-12-11T10:30:00Z"
        '503':
          description: Service unhealthy
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HealthResponse'
              examples:
                unhealthy:
                  value:
                    status: "unhealthy"
                    services:
                      database: "healthy"
                      vector_db: "unhealthy"
                      ai_service: "healthy"
                    timestamp: "2025-12-11T10:30:00Z"

components:
  securitySchemes:
    BetterAuth:
      type: http
      scheme: bearer
      description: |
        Better Auth session token. Obtained after successful OAuth or email/password login.
        Include in Authorization header as: `Authorization: Bearer <token>`

  schemas:
    ChatRequest:
      type: object
      required:
        - query
        - session_id
      properties:
        query:
          type: string
          minLength: 1
          maxLength: 2000
          description: User's question about book content
          example: "What is a Vision-Language-Action model?"
        selected_text:
          type: string
          nullable: true
          maxLength: 10000
          description: Optional selected text from book for context-specific questions
          example: null
        session_id:
          type: string
          description: Better Auth session ID for conversation context
          example: "sess_abc123xyz"

    ChatResponse:
      type: object
      required:
        - answer
        - citations
        - agent_used
        - confidence
        - chunks_retrieved
      properties:
        answer:
          type: string
          description: AI-generated answer grounded in book content
          example: "A Vision-Language-Action (VLA) model combines visual perception, natural language understanding, and robotic control..."
        citations:
          type: array
          items:
            $ref: '#/components/schemas/Citation'
          description: References to book sections used to generate answer
        agent_used:
          type: string
          enum:
            - "Triage Agent"
            - "Book Q&A Agent"
            - "Selected Text Agent"
          description: Which agent handled the query
          example: "Book Q&A Agent"
        confidence:
          type: number
          format: float
          minimum: 0.0
          maximum: 1.0
          description: Confidence score of the answer (0-1)
          example: 0.92
        chunks_retrieved:
          type: integer
          minimum: 0
          description: Number of book chunks retrieved for context
          example: 5

    Citation:
      type: object
      required:
        - chapter
        - section
        - line_range
        - file_path
      properties:
        chapter:
          type: string
          description: Chapter number and title
          example: "Chapter 4"
        section:
          type: string
          description: Section title
          example: "4.1 Introduction to VLA"
        line_range:
          type: string
          pattern: '^\d+-\d+$'
          description: Line range in source file (e.g., "12-25")
          example: "12-25"
        file_path:
          type: string
          description: Relative path to source MDX file
          example: "docs/vla/introduction.mdx"

    ExpertiseUpdateRequest:
      type: object
      required:
        - session_id
        - expertise_level
      properties:
        session_id:
          type: string
          description: Better Auth session ID
          example: "sess_abc123xyz"
        expertise_level:
          type: string
          enum:
            - beginner
            - intermediate
            - advanced
          description: User's expertise level for response tailoring
          example: "advanced"

    ExpertiseUpdateResponse:
      type: object
      required:
        - success
        - new_level
      properties:
        success:
          type: boolean
          description: Whether update was successful
          example: true
        new_level:
          type: string
          enum:
            - beginner
            - intermediate
            - advanced
          description: Confirmed new expertise level
          example: "advanced"

    ErrorResponse:
      type: object
      required:
        - error
      properties:
        error:
          $ref: '#/components/schemas/ErrorDetail'

    ErrorDetail:
      type: object
      required:
        - error_code
        - message
      properties:
        error_code:
          type: string
          enum:
            - VALIDATION_ERROR
            - UNAUTHORIZED
            - RATE_LIMIT_EXCEEDED
            - SERVICE_ERROR
            - NOT_FOUND
            - INTERNAL_ERROR
          description: Machine-readable error code
          example: "RATE_LIMIT_EXCEEDED"
        message:
          type: string
          description: Human-readable error message
          example: "Too many requests. Please wait before retrying."
        service:
          type: string
          nullable: true
          enum:
            - openai
            - qdrant
            - database
          description: Which service encountered the error (if applicable)
          example: "openai"
        retry_after:
          type: integer
          nullable: true
          description: Seconds to wait before retrying (for rate limits)
          example: 60

    HealthResponse:
      type: object
      required:
        - status
        - services
        - timestamp
      properties:
        status:
          type: string
          enum:
            - healthy
            - degraded
            - unhealthy
          description: Overall system health status
          example: "healthy"
        services:
          type: object
          properties:
            database:
              type: string
              enum:
                - healthy
                - unhealthy
              example: "healthy"
            vector_db:
              type: string
              enum:
                - healthy
                - unhealthy
              example: "healthy"
            ai_service:
              type: string
              enum:
                - healthy
                - unhealthy
              example: "healthy"
          description: Health status of individual services
        timestamp:
          type: string
          format: date-time
          description: ISO 8601 timestamp of health check
          example: "2025-12-11T10:30:00Z"
